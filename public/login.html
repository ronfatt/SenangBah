<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Login Â· SPM English Booster</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body>
  <main class="shell">
    <section class="card">
      <h1>Login</h1>
      <div class="toggle">
        <label><input type="radio" name="loginRole" value="student" checked /> Student</label>
        <label><input type="radio" name="loginRole" value="teacher" /> Teacher</label>
      </div>
      <form id="loginForm" class="form">
        <label>Email
          <input type="email" name="email" required />
        </label>
        <label>Password
          <input type="password" name="password" required />
        </label>
        <button class="btn primary" type="submit">Login</button>
        <p id="loginError" class="error"></p>
      </form>
    </section>

    <section class="card">
      <h1>Create account</h1>
      <div class="toggle">
        <label><input type="radio" name="registerRole" value="student" checked /> Student</label>
        <label><input type="radio" name="registerRole" value="teacher" /> Teacher</label>
      </div>
      <form id="registerForm" class="form">
        <label>Name
          <input type="text" name="name" required />
        </label>
        <label>Email
          <input type="email" name="email" required />
        </label>
        <label>Password
          <input type="password" name="password" required />
        </label>
        <div id="studentFields">
          <label>Estimated Band
            <input type="number" name="estimated_band" min="2" max="6" step="0.5" value="4" />
          </label>
        <label>Teacher Code
          <input type="text" name="teacher_code" id="teacherCodeInput" placeholder="e.g. ABCD1234" />
        </label>
        <p class="muted small" id="teacherNamePreview"></p>
        </div>
        <div id="teacherFields" style="display:none;">
          <label>School Code
            <input type="text" name="school_code" value="senang" />
          </label>
        </div>
        <button class="btn primary" type="submit">Create & Start</button>
        <p id="registerError" class="error"></p>
      </form>
    </section>
  </main>

  <script>
    async function postJSON(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      return { ok: res.ok, data: await res.json() };
    }

    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginError = document.getElementById('loginError');
    const registerError = document.getElementById('registerError');
    const studentFields = document.getElementById('studentFields');
    const teacherFields = document.getElementById('teacherFields');
    const teacherCodeInput = document.getElementById('teacherCodeInput');
    const teacherNamePreview = document.getElementById('teacherNamePreview');

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.textContent = '';
      const formData = new FormData(loginForm);
      const payload = Object.fromEntries(formData.entries());
      const loginRole = document.querySelector('input[name=\"loginRole\"]:checked')?.value || 'student';
      const url = loginRole === 'teacher' ? '/api/teacher/login' : '/api/auth/login';
      const res = await postJSON(url, payload);
      if (!res.ok) {
        loginError.textContent = res.data?.error || 'Login failed';
        return;
      }
      window.location.href = loginRole === 'teacher' ? '/teacher' : '/dashboard.html';
    });

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      registerError.textContent = '';
      const formData = new FormData(registerForm);
      const payload = Object.fromEntries(formData.entries());
      const registerRole = document.querySelector('input[name=\"registerRole\"]:checked')?.value || 'student';
      if (registerRole === 'student') {
        payload.estimated_band = Number(payload.estimated_band || 4);
        payload.form = 5;
      }
      const url = registerRole === 'teacher' ? '/api/teacher/register' : '/api/auth/register';
      const res = await postJSON(url, payload);
      if (!res.ok) {
        registerError.textContent = res.data?.error || 'Registration failed';
        return;
      }
      window.location.href = registerRole === 'teacher' ? '/teacher' : '/dashboard.html';
    });

    document.querySelectorAll('input[name=\"registerRole\"]').forEach((el) => {
      el.addEventListener('change', () => {
        const role = document.querySelector('input[name=\"registerRole\"]:checked')?.value || 'student';
        studentFields.style.display = role === 'student' ? 'block' : 'none';
        teacherFields.style.display = role === 'teacher' ? 'block' : 'none';
      });
    });

    let teacherLookupTimer;
    if (teacherCodeInput) {
      teacherCodeInput.addEventListener('input', () => {
        if (teacherLookupTimer) clearTimeout(teacherLookupTimer);
        const code = teacherCodeInput.value.trim();
        if (!code) {
          teacherNamePreview.textContent = '';
          return;
        }
        teacherLookupTimer = setTimeout(async () => {
          const res = await postJSON('/api/teacher/teacher-name', { teacher_code: code });
          if (!res.ok) {
            teacherNamePreview.textContent = 'Teacher code not found';
            return;
          }
          teacherNamePreview.textContent = `Teacher: ${res.data?.name || ''}`;
        }, 400);
      });
    }
  </script>
</body>
</html>
