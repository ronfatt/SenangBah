<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Enter Your Training Portal ¬∑ SenangBah</title>
  <link rel="stylesheet" href="/styles.css" />
</head>
<body class="auth-page">
  <main class="auth-shell">
    <section class="auth-brand card">
      <p class="eyebrow">SPM English Performance System</p>
      <h1>Enter Your Training Portal</h1>
      <p class="sub">Secure Access to Your Training Dashboard</p>
      <p class="auth-small">Based on Real SPM Marking Criteria</p>
      <aside class="mini-grade-panel">
        <p class="mini-grade-title">Class Progress Linked</p>
        <p>Last Estimated Grade: C+</p>
        <div class="mini-progress"><i style="width: 62%"></i></div>
        <p><span class="grade-now">C+</span> <span class="grade-arrow">‚Üí</span> <span class="grade-target">B+</span></p>
      </aside>
    </section>

    <section class="auth-panel card" id="authPanel">
      <div class="auth-tabs" role="tablist" aria-label="Auth tabs">
        <button class="auth-tab active" id="tabLogin" type="button" role="tab" aria-selected="true">Login</button>
        <button class="auth-tab" id="tabRegister" type="button" role="tab" aria-selected="false">Create Account</button>
      </div>

      <section id="loginSection">
        <h2>Continue Your Training</h2>
        <form id="loginForm" class="form">
          <label>Email
            <input type="email" name="email" required />
          </label>
          <label>Password
            <input type="password" name="password" required />
          </label>
          <div class="auth-login-row">
            <label class="remember"><input type="checkbox" name="remember" /> Remember me</label>
            <a class="small" href="/teacher">Forgot password?</a>
          </div>
          <button class="btn primary auth-cta" id="loginBtn" type="submit">Continue to Dashboard</button>
          <p class="muted small">Teacher login is available at <a href="/teacher">Teacher Portal</a>.</p>
          <p id="loginError" class="error"></p>
        </form>
      </section>

      <section id="registerSection" class="hidden">
        <h2>Start Your SPM English Training</h2>
        <div class="auth-divider"><span>New Student?</span></div>

        <section class="verify-card access-key-card" id="verifyCard">
          <p class="verify-title">Step 1</p>
          <h3>Enter Your Class Access Code</h3>
          <label>Teacher Referral Code (Required)
            <input type="text" id="verifyTeacherCodeInput" placeholder="e.g. ABCD1234" />
          </label>
          <button class="btn ghost" id="verifyTeacherBtn" type="button">Verify &amp; Link to Class</button>
          <p class="muted small">This code is provided by your school teacher. It links your progress to your class dashboard.</p>
          <p class="error" id="verifyTeacherError"></p>
          <div id="verifySuccess" class="verify-success hidden">
            <p><strong>‚úî Successfully Linked</strong></p>
            <p>üè´ <span id="verifySchool"></span></p>
            <p>Teacher: <span id="verifyTeacherName"></span></p>
          </div>
        </section>

        <section class="verify-card hidden" id="registerCard">
          <p class="verify-title">Step 2</p>
          <h3>Create Student Account</h3>
          <form id="registerForm" class="form">
            <input type="hidden" name="teacher_code" id="teacherCodeHidden" />
            <label>Full Name
              <input type="text" name="name" required />
            </label>
            <label>Email
              <input type="email" name="email" required />
            </label>
            <label>Password
              <input type="password" id="registerPassword" name="password" required />
            </label>
            <div class="password-meter-wrap">
              <div class="password-meter" id="passwordMeter"><i></i></div>
              <span id="passwordMeterText" class="muted small">Password strength: low</span>
            </div>
            <label>Current Estimated Band
              <select name="estimated_band">
                <option value="2">Band 2</option>
                <option value="3">Band 3</option>
                <option value="4" selected>Band 4</option>
                <option value="5">Band 5</option>
                <option value="6">Band 6</option>
              </select>
            </label>
            <p class="muted small">By continuing, you agree to the pilot programme terms.</p>
            <button class="btn primary auth-cta" id="registerBtn" type="submit" disabled>Start My Training</button>
            <p id="registerError" class="error"></p>
          </form>
        </section>
      </section>
    </section>
  </main>

  <script>
    async function postJSON(url, data) {
      const res = await fetch(url, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });
      return { ok: res.ok, data: await res.json() };
    }

    const panel = document.getElementById('authPanel');
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');
    const loginSection = document.getElementById('loginSection');
    const registerSection = document.getElementById('registerSection');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const loginError = document.getElementById('loginError');
    const registerError = document.getElementById('registerError');
    const loginBtn = document.getElementById('loginBtn');
    const registerBtn = document.getElementById('registerBtn');

    const verifyTeacherCodeInput = document.getElementById('verifyTeacherCodeInput');
    const verifyTeacherBtn = document.getElementById('verifyTeacherBtn');
    const verifyTeacherError = document.getElementById('verifyTeacherError');
    const verifySuccess = document.getElementById('verifySuccess');
    const verifySchool = document.getElementById('verifySchool');
    const verifyTeacherName = document.getElementById('verifyTeacherName');
    const registerCard = document.getElementById('registerCard');
    const teacherCodeHidden = document.getElementById('teacherCodeHidden');

    const registerPassword = document.getElementById('registerPassword');
    const passwordMeter = document.getElementById('passwordMeter');
    const passwordMeterText = document.getElementById('passwordMeterText');

    function setTab(tab) {
      const isLogin = tab === 'login';
      tabLogin.classList.toggle('active', isLogin);
      tabRegister.classList.toggle('active', !isLogin);
      tabLogin.setAttribute('aria-selected', String(isLogin));
      tabRegister.setAttribute('aria-selected', String(!isLogin));
      loginSection.classList.toggle('hidden', !isLogin);
      registerSection.classList.toggle('hidden', isLogin);
    }

    tabLogin.addEventListener('click', () => setTab('login'));
    tabRegister.addEventListener('click', () => setTab('register'));

    function setLoading(button, loading, textLoading, textNormal) {
      button.disabled = loading;
      button.classList.toggle('is-loading', loading);
      button.textContent = loading ? textLoading : textNormal;
    }

    function goAfterSuccess(url) {
      panel.classList.add('auth-success');
      setTimeout(() => {
        window.location.href = url;
      }, 260);
    }

    function scorePassword(value) {
      let score = 0;
      if (value.length >= 8) score += 35;
      if (/[A-Z]/.test(value)) score += 20;
      if (/[a-z]/.test(value)) score += 15;
      if (/\d/.test(value)) score += 15;
      if (/[^A-Za-z0-9]/.test(value)) score += 15;
      return Math.min(100, score);
    }

    registerPassword.addEventListener('input', () => {
      const score = scorePassword(registerPassword.value || '');
      passwordMeter.firstElementChild.style.width = score + '%';
      const label = score < 40 ? 'low' : score < 70 ? 'medium' : 'strong';
      passwordMeter.firstElementChild.style.background = score < 70 ? '#60a5fa' : '#22c55e';
      passwordMeterText.textContent = `Password strength: ${label}`;
    });

    verifyTeacherBtn.addEventListener('click', async () => {
      verifyTeacherError.textContent = '';
      verifySuccess.classList.add('hidden');
      verifySuccess.classList.remove('fade-in');
      registerCard.classList.add('hidden');
      registerBtn.disabled = true;
      const code = verifyTeacherCodeInput.value.trim();
      if (!code) {
        verifyTeacherError.textContent = 'Teacher code is required.';
        return;
      }
      setLoading(verifyTeacherBtn, true, 'Verifying...', 'Verify Code');
      const res = await postJSON('/api/teacher/teacher-name', { teacher_code: code });
      setLoading(verifyTeacherBtn, false, 'Verifying...', 'Verify Code');
      if (!res.ok) {
        verifyTeacherError.textContent = 'Teacher code not found.';
        return;
      }
      teacherCodeHidden.value = code.toUpperCase();
      verifySchool.textContent = res.data?.school_name || res.data?.school_code || 'School';
      verifyTeacherName.textContent = res.data?.name || '';
      verifySuccess.classList.remove('hidden');
      verifySuccess.classList.add('fade-in');
      registerCard.classList.remove('hidden');
      registerBtn.disabled = false;
    });

    verifyTeacherCodeInput.addEventListener('input', () => {
      const normalized = verifyTeacherCodeInput.value.toUpperCase().replace(/\s+/g, '');
      verifyTeacherCodeInput.value = normalized;
      verifyTeacherError.textContent = '';
      verifySuccess.classList.add('hidden');
      verifySuccess.classList.remove('fade-in');
      registerCard.classList.add('hidden');
      registerBtn.disabled = true;
      teacherCodeHidden.value = '';
    });

    verifyTeacherCodeInput.addEventListener('paste', (event) => {
      event.preventDefault();
      const pasted = (event.clipboardData?.getData('text') || '').toUpperCase().replace(/\s+/g, '');
      verifyTeacherCodeInput.value = pasted;
      verifyTeacherCodeInput.dispatchEvent(new Event('input'));
    });

    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      loginError.textContent = '';
      const formData = new FormData(loginForm);
      const payload = Object.fromEntries(formData.entries());
      delete payload.remember;
      setLoading(loginBtn, true, 'Checking...', 'Continue to Dashboard');
      const res = await postJSON('/api/auth/login', payload);
      setLoading(loginBtn, false, 'Checking...', 'Continue to Dashboard');
      if (!res.ok) {
        loginError.textContent = res.data?.error || 'Unable to sign in now.';
        return;
      }
      goAfterSuccess('/dashboard.html');
    });

    registerForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      registerError.textContent = '';
      const formData = new FormData(registerForm);
      const payload = Object.fromEntries(formData.entries());
      payload.estimated_band = Number(payload.estimated_band || 4);
      payload.form = 5;
      if (!payload.teacher_code) {
        registerError.textContent = 'Please verify teacher code first.';
        return;
      }
      setLoading(registerBtn, true, 'Creating...', 'Start My Training');
      const res = await postJSON('/api/auth/register', payload);
      setLoading(registerBtn, false, 'Creating...', 'Start My Training');
      if (!res.ok) {
        registerError.textContent = res.data?.error || 'Unable to create account now.';
        return;
      }
      goAfterSuccess('/dashboard.html');
    });
  </script>
</body>
</html>
